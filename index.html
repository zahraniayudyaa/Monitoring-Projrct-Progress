<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoring Progress</title>
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
      background: #f9f9f9;
      font-size: 25px;
    }
    h2 {
      margin-top: 40px;
      color: #333;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 20px;
    }
    button {
      background-color: #3498db;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      background: #e7eaf6;
      width: 240px;
      padding: 10px 30px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-right: 2px solid #bfc9d9;
    }
    .sidebar h2 {
      font-size: 1.2em;
      margin-bottom: 10px;
      color: #4f5d75;
      letter-spacing: 1px;
    }
    .sidebar select, .sidebar input[type="text"] {
      width: 100%;
      padding: 7px 10px;
      border-radius: 6px;
      border: 1px solid #bfc9d9;
      margin-bottom: 5px;
      font-size: 20px;
    }
    .sidebar .link-box label {
      font-size: 20px;
      color: #4f5d75;
    }
    .sidebar .link-box input {
      font-size: 20px;
      background: #f7f7f7;
    }
    .main-content {
      flex: 1;
      padding: 30px 40px;
      background: #f9f9f9;
    }
    header h1 {
      font-size: 3em;
      color: #4f5d75;
      margin-bottom: 20px;
      letter-spacing: 2px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px;
      margin-bottom: 30px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px #e7eaf6;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .card h3 {
      font-size: 1em;
      color: #4f5d75;
      margin-bottom: 10px;
    }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th { 
      background-color: #eee;
    }
    canvas {
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      margin-top: 30px;
      border-radius: 8px;
    }
    .dashboard-charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      font-size: 25px;
    }
    .chart-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px #e7eaf6;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .chart-card h3 {
      font-size: 1em;
      color: #4f5d75;
      margin-bottom: 10px;
      text-align: center;
      font-size: 25px;
    }
    .table-fixed-wrapper {
      width: 100%;
      max-width: 100%;
      height: 400px; /* Atur tinggi sesuai kebutuhan */
      overflow-y: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px #e7eaf6;
      margin-bottom: 30px;
    }

    .table-fixed-wrapper table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px; /* Agar kolom tidak mengecil */
      font-size: 20px;
    }

    .table-fixed-wrapper th, .table-fixed-wrapper td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 20px;
    }

    .table-fixed-wrapper th {
      background-color: #eee;
      position: sticky;
      top: 0;
      z-index: 2;
      font-size: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <h2>Menu</h2>
    <div class="link-box">
      <label for="filterDate">Filter Date:</label>
      <input type="date" id="filterDate">
    </div>
    <div class="link-box">
      <label for="filterNoOrder">Cari No Order:</label>
      <input type="text" id="filterNoOrder" placeholder="No Order">
    </div>
    <button onclick="applyFilter()">Terapkan Filter</button>
    <button onclick="resetFilter()">Reset</button>
  </div>

  <div class="main-content">
    <header>
      <h1>Monitoring Progress</h1>
    </header>

    <h2>Form Input Pekerjaan</h2>
    <form id="jobForm">
      <label for="input-date">Masukkan Tanggal Mulai</label>
      <input type="date" id="input-date" name="DATE" required>
      
      <input type="text" name="NO ORDER" placeholder="No Order" required>
      <input type="text" name="LINE" placeholder="Line" required>
      <input type="text" name="JOB DESC" placeholder="Job Desc" required>
      <input type="text" name="REGISTRASI" placeholder="Registrasi" required>
      <input type="text" name="PROGRESS" placeholder="Progress (%)" required>
      <input type="text" name="MAN HOURS" placeholder="Man Hours" required>
      
      <label for="input-target-finish">Masukkan Tanggal Selesai </label>
      <input type="date" id="input-target-finish" name="TARGET FINISH" required>
      
      <button type="submit">Kirim</button>
    </form>

    <!-- Chart Dashboard -->
    <div class="dashboard-charts">
      <div class="chart-card">
        <h3>Rata-rata Progress per Line</h3>
        <canvas id="stackedChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Rata-rata Progress per Registrasi</h3>
        <canvas id="pieChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Jumlah Job & Man Hours per Registrasi</h3>
        <canvas id="lineChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Total Progress & Durasi Project per No Order</h3>
        <canvas id="ganttChart"></canvas>
      </div>
    </div>

    <h2>Data Progress</h2>
    <div class="table-fixed-wrapper">
      <table id="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>No Order</th>
            <th>Line</th>
            <th>Job Desc</th>
            <th>Registrasi</th>
            <th>Progress</th>
            <th>Man Hours</th>
            <th>Target Finish</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="8">Memuat data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const apiUrl = "https://sheetdb.io/api/v1/7absym1gp66uj";
const tbody = document.querySelector("#data-table tbody");
const form = document.getElementById("jobForm");
let fullData = [], filteredData = [];
let stackedChart;
let pieChart;
let lineChart;
let ganttChart;

const parseProgress = v => parseFloat((v || "").replace("%", "")) || 0;
const formatDate = s => s ? new Date(s).toISOString().slice(0, 10) : "";

function getWeek(dateStr) {
  const d = new Date(dateStr);
  d.setHours(0,0,0,0);
  // ISO week: Thursday is always in week
  d.setDate(d.getDate() + 4 - (d.getDay()||7));
  const yearStart = new Date(d.getFullYear(),0,1);
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  return `${d.getFullYear()}-W${weekNo}`;
}

function matchesFilter(row) {
  const dateFilter = document.getElementById("filterDate").value;
  const noOrderFilter = document.getElementById("filterNoOrder").value.toLowerCase().trim();
  let matchesDate = true;

  // Cari key yang mengandung "no order" (case-insensitive, ignore space)
  const noOrderKey = Object.keys(row).find(
    k => k.replace(/\s+/g, '').toLowerCase() === "noorder"
  );
  const noOrderValue = (row[noOrderKey] || "").toLowerCase().trim();

  if (dateFilter && row.DATE) {
    matchesDate = row.DATE.startsWith(dateFilter);
  }

  const matchesNoOrder = !noOrderFilter || noOrderValue.includes(noOrderFilter);
  return matchesDate && matchesNoOrder;
}

async function loadTableData() {
  tbody.innerHTML = "<tr><td colspan='9'>Loading...</td></tr>";
  try {
    const data = await fetch(apiUrl).then(res => res.json());
    fullData = data;
    applyFilter();
  } catch (err) {
    console.error(err);
    tbody.innerHTML = "<tr><td colspan='9'>Gagal memuat data.</td></tr>";
  }
}

function applyFilter() {
  filteredData = fullData.filter(matchesFilter);
  renderTable(filteredData);
  renderChart(filteredData);
  renderPieChart(filteredData);
  renderLineChart(filteredData);
  renderGanttChart(filteredData);
}

function resetFilter() {
  document.getElementById("filterDate").value = "";
  document.getElementById("filterNoOrder").value = "";
  applyFilter();
}

function renderTable(data) {
  tbody.innerHTML = "";
  data.sort((a, b) => new Date(b.DATE) - new Date(a.DATE)).forEach((row, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${formatDate(row.DATE)}</td>
      <td>${row["NO ORDER"]}</td>
      <td>${row.LINE}</td>
      <td>${row["JOB DESC"]}</td>
      <td>${row.REGISTRASI}</td>
      <td>${row.PROGRESS}</td>
      <td>${row["MAN HOURS"]}</td>
      <td>${formatDate(row["TARGET FINISH"])}</td>
      <td>
        <button onclick='onEditRow(${idx})' style="margin-top:6px;background:#f1c40f;color:#222;border:none;padding:6px 12px;border-radius:6px;cursor:pointer">Edit</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function renderChart(data)  {
  const grouped = {};
  data.forEach(d => {
    const line = d.LINE || "LAINNYA";
    if (!grouped[line]) grouped[line] = [];
    grouped[line].push(parseProgress(d.PROGRESS));
  });

  const labels = Object.keys(grouped);
  const dataset = { 
    label: "Progress (%)",
    data: labels.map(k => grouped[k].reduce((a, b) => a + b, 0) / grouped[k].length),
    backgroundColor: "#3498db",
  };

  const ctx = document.getElementById("stackedChart").getContext("2d");
  stackedChart?.destroy();
  stackedChart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [dataset] },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Rata-rata Progress per Line" }
      },
      scales: {
        y: { beginAtZero: true, max: 100 }
      }
    }
  });
}

function renderPieChart(data) {
  // Rata-rata progress (%) per REGISTRASI
  const regMap = {};
  data.forEach(d => {
    const reg = d.REGISTRASI || "LAINNYA";
    if (!regMap[reg]) regMap[reg] = [];
    regMap[reg].push(parseProgress(d.PROGRESS));
  });
  const labels = Object.keys(regMap);
  const values = labels.map(l => {
    const arr = regMap[l];
    return arr.length ? (arr.reduce((a, b) => a + b, 0) / arr.length) : 0;
  });
  const colors = labels.map((_, i) => `hsl(${i * 360 / labels.length},70%,60%)`);

  const ctx = document.getElementById("pieChart").getContext("2d");
  pieChart?.destroy();
  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors
      }]
    },
    options: {
      plugins: {
        title: { display: true, text: "Rata-rata Progress (%) per REGISTRASI" }
      }
    }
  });
}

function renderLineChart(data) {
  // Jumlah job & jumlah man hours per REGISTRASI
  const regMap = {};
  data.forEach(d => {
    const reg = d.REGISTRASI || "LAINNYA";
    if (!regMap[reg]) regMap[reg] = { count: 0, manhours: 0 };
    regMap[reg].count += 1;
    regMap[reg].manhours += parseFloat(d["MAN HOURS"]) || 0;
  });
  const labels = Object.keys(regMap);
  const jobCounts = labels.map(l => regMap[l].count);
  const manHours = labels.map(l => regMap[l].manhours);

  const ctx = document.getElementById("lineChart").getContext("2d");
  lineChart?.destroy();
  lineChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Jumlah Job",
          data: jobCounts,
          borderColor: "#3498db",
          backgroundColor: "rgba(52,152,219,0.2)",
          yAxisID: 'y',
        },
        {
          label: "Jumlah Man Hours",
          data: manHours,
          borderColor: "#e67e22",
          backgroundColor: "rgba(230,126,34,0.2)",
          yAxisID: 'y1',
          
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Jumlah Job & Man Hours per REGISTRASI"}
      },
      scales: {
        y: { beginAtZero: true, position: 'left', title: { display: true , text: 'Jumlah Job' } },
        y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Man Hours' }, grid: { drawOnChartArea: false } }
      }
    }
  });
}

function renderGanttChart(data) {
  // Bar chart: rata-rata progress (%) dan jumlah hari per NO ORDER
  const orders = {};
  data.forEach(d => {
    const order = d["NO ORDER"] || "LAINNYA";
    if (!orders[order]) {
      orders[order] = {
        progressSum: 0,
        count: 0,
        start: d.DATE ? new Date(d.DATE) : null,
        end: d["TARGET FINISH"] ? new Date(d["TARGET FINISH"]) : null
      };
    }
    orders[order].progressSum += parseProgress(d.PROGRESS);
    orders[order].count += 1;
    // Ambil tanggal paling awal dan akhir jika ada beberapa entry per order
    if (d.DATE && new Date(d.DATE) < orders[order].start) orders[order].start = new Date(d.DATE);
    if (d["TARGET FINISH"] && new Date(d["TARGET FINISH"]) > orders[order].end) orders[order].end = new Date(d["TARGET FINISH"]);
  });

  const labels = Object.keys(orders);
  // Hitung rata-rata progress per NO ORDER
  const avgProgress = labels.map(l => {
    const o = orders[l];
    return o.count ? (o.progressSum / o.count) : 0;
  });
  const durations = labels.map(l => {
    const o = orders[l];
    if (o.start && o.end) {
      return (o.end - o.start) / (1000 * 60 * 60 * 24); // hari
    }
    return 0;
  });

  const ctx = document.getElementById("ganttChart").getContext("2d");
  ganttChart?.destroy();
  ganttChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [
        {
          label: "Rata-rata Progress (%)",
          data: avgProgress,
          backgroundColor: "rgba(52, 152, 219, 0.7)",
          yAxisID: 'y',
        },
        {
          label: "Durasi Project (hari)",
          data: durations,
          backgroundColor: "rgba(46, 204, 113, 0.7)",
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      indexAxis: 'y',
      plugins: {
        title: { display: true, text: "Rata-rata Progress & Durasi Project per NO ORDER" },
        tooltip: {
          callbacks: {
            label: function(context) {
              if (context.dataset.label === "Rata-rata  Progress (%)") {
                return `Rata-rata Progress: ${context.raw.toFixed(2)}%`;
              } else {
                return `Durasi: ${context.raw.toFixed(1)} hari`;
              }
            }
          }
        }
      },
      scales: {
        y: { // NO ORDER (kategori)
          beginAtZero: true,
          title: { display: true, text: "NO ORDER" 
        }
        },
        x: { // Untuk bar horizontal
          beginAtZero: true,
        },
        y1: {
          position: 'right',
          grid: { drawOnChartArea: false },
          display: false // Tidak tampilkan axis kedua, hanya overlay bar
        }
      }
    }
  });
}

function editRow(row) {
  for (const key in row) {
    if (form[key]) form[key].value = row[key];
  }
  form.dataset.editId = row.__id;
}

async function deleteRow(row) {
  if (!confirm("Yakin ingin menghapus?")) return;
  try {
    // Tandai data sebagai DELETED (soft delete)
    const updatedRow = { ...row, STATUS: "DELETED" };
    await fetch(`${apiUrl}/row`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updatedRow)
    });
    loadTableData();
  } catch (err) {
    console.error(err);
    alert("Gagal menghapus!");
  }
}

form.addEventListener("submit", async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form));
  const progress = parseProgress(data.PROGRESS);
  if (progress < 0 || progress > 100) return alert("Progress harus 0â€“100");

  const editNoOrder = form.dataset.editNoOrder;
  const editDate = form.dataset.editDate;
  try {
    if (editNoOrder && editDate) {
      // 1. Soft delete data lama
      const filter = { "NO ORDER": editNoOrder, "DATE": editDate };
      await fetch(`${apiUrl}/row`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...filter, STATUS: "DELETED" })
      });
      // 2. Tambah data baru
      await fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      delete form.dataset.editNoOrder;
      delete form.dataset.editDate;
    } else {
      // Tambah data baru
      await fetch(apiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
    }
    form.reset();
    loadTableData();
  } catch (err) {
    console.error(err);
    alert("Gagal mengirim data!");
  }
});

document.addEventListener("DOMContentLoaded", () => {
  Inputmask().mask(document.querySelectorAll("input"));
  loadTableData();
});

async function onToggleStatus(checkbox, idx) {
  const row = filteredData[idx];
  const isActive = !row.STATUS || row.STATUS.toUpperCase() !== "TIDAK AKTIF";
  const action = isActive ? "menonaktifkan" : "mengaktifkan";
  if (!confirm(`Yakin ingin ${action} data ini?`)) {
    // Batalkan toggle jika user batal
    checkbox.checked = isActive;
    return;
  }
  const newStatus = isActive ? "TIDAK AKTIF" : "";
  const filter = { "NO ORDER": row["NO ORDER"], "DATE": row.DATE };
  const update = { ...filter, STATUS: newStatus };
  try {
    await fetch(`${apiUrl}/row`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(update)
    });
    loadTableData();
  } catch (err) {
    console.error(err);
    alert("Gagal mengubah status!");
    checkbox.checked = isActive; // Kembalikan toggle jika gagal
  }
}

function onEditRow(idx) {
  const row = filteredData[idx];
  form["DATE"].value = row.DATE || "";
  form["NO ORDER"].value = row["NO ORDER"] || "";
  form.dataset.editNoOrder = row["NO ORDER"];
  form.dataset.editDate = row.DATE;
}
</script>
</body>
</html>